// CBAHI Clinical Privileges Management System
// Prisma Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  MEDICAL_DIRECTOR
  HEAD_OF_DEPT
  HEAD_OF_SECTION
  COMMITTEE_MEMBER
  EMPLOYEE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  TERMINATED
}

// Practitioner classification per CBAHI requirements
enum PractitionerType {
  GP                // General Practitioner (طبيب عام)
  SPECIALIST        // Specialist (أخصائي)
  CONSULTANT        // Consultant (استشاري)
}

// Dental specialties for approval routing
enum DentalSpecialty {
  GENERAL_DENTISTRY
  PEDODONTICS           // طب أسنان الأطفال
  PROSTHODONTICS        // تركيبات الأسنان
  ENDODONTICS           // علاج جذور الأسنان
  ORTHODONTICS          // تقويم الأسنان
  RESTORATIVE           // إصلاح الأسنان
  PERIODONTICS          // علاج اللثة
  ORAL_SURGERY          // جراحة الفم والوجه والفكين
  ORAL_MEDICINE         // طب الفم
  IMPLANTS              // زراعة الأسنان
  ADVANCED_GENERAL      // طب أسنان عام متقدم
}

enum EmailProvider {
  SMTP
  MICROSOFT_GRAPH
  SENDGRID
}

enum PrivilegeCategory {
  CORE
  RESTORATIVE
  PEDIATRIC
  ORTHODONTICS
  ENDODONTICS
  PERIODONTICS
  PROSTHODONTICS
  ORAL_SURGERY
  ORAL_MEDICINE
  RADIOLOGY
  DIAGNOSTIC
  PREVENTIVE
  IMPLANT
  COSMETIC
  OTHER
}

enum RequestType {
  NEW
  REAPPLICATION
}

enum PrivilegeRequestType {
  CORE
  NON_CORE
  EXTRA
}

enum RequestStatus {
  DRAFT
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  CANCELLED
}

enum PrivilegeStatus {
  PENDING
  APPROVED
  REJECTED
  DEFERRED
}

enum ApprovalLevel {
  HEAD_OF_SECTION
  HEAD_OF_DEPT
  COMMITTEE
  MEDICAL_DIRECTOR
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  SKIPPED
}

enum AttachmentType {
  CV
  MEDICAL_LICENSE
  SCFHS_LICENSE
  BOARD_CERTIFICATE
  SPECIALTY_CERTIFICATE
  EXPERIENCE_LETTER
  TRAINING_CERTIFICATE
  OTHER
}

enum EscalationStatus {
  ACTIVE
  RESOLVED
  CANCELLED
}

enum NotificationType {
  REQUEST_SUBMITTED
  APPROVAL_REQUIRED
  REQUEST_APPROVED
  REQUEST_REJECTED
  ESCALATION_LEVEL1
  ESCALATION_LEVEL2
  ESCALATION_LEVEL3
  REMINDER
  SYNC_COMPLETED
  SYNC_FAILED
  SYSTEM_ALERT
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

// ============================================================================
// MODELS
// ============================================================================

/// Users synced from Jisr HR system
model User {
  id              String     @id @default(cuid())
  jisrEmployeeId  Int        @unique
  employeeCode    String?
  email           String     @unique
  nameEn          String
  nameAr          String?

  // Job Information
  jobTitleId      Int?
  jobTitleEn      String?
  jobTitleAr      String?

  // Department Information
  departmentId    Int?
  departmentEn    String?
  departmentAr    String?

  // Location Information
  locationId      Int?
  locationEn      String?
  locationAr      String?

  // Hierarchy
  lineManagerId   String?
  lineManager     User?      @relation("LineManager", fields: [lineManagerId], references: [id])
  directReports   User[]     @relation("LineManager")

  // Nationality
  nationalityId   Int?
  nationalityEn   String?
  nationalityAr   String?

  // Document Information (from Jisr identification_info)
  documentNumber  String?    // National ID / Iqama number
  documentType    String?    // Type of document (national_id, iqama, passport)
  passportNumber  String?
  iqamaNumber     String?
  nationalIdNumber String?

  // Photo
  photoUrl        String?    // Avatar/photo URL from Jisr

  // Branch Information (from Jisr)
  branchId        Int?
  branchEn        String?
  branchAr        String?

  // Dates
  joiningDate     DateTime?

  // Status and Role
  status          UserStatus @default(ACTIVE)
  role            UserRole   @default(EMPLOYEE)

  // Dental Practitioner Specific
  scfhsNo         String?    // Saudi Commission for Health Specialties number

  // CBAHI Privileges Fields (per government requirements)
  practitionerType    PractitionerType?    // GP, Specialist, or Consultant
  specialty           DentalSpecialty?     // Primary dental specialty
  additionalSpecialties DentalSpecialty[]  // Additional specialties they can approve
  isCommitteeMember   Boolean    @default(false)  // Member of privileges committee
  isCommitteeChair    Boolean    @default(false)  // Chair of privileges committee
  canApprovePrivileges Boolean   @default(false)  // Can approve privilege requests

  // Sync Information
  isActive        Boolean    @default(true)
  lastSyncedAt    DateTime?

  // Timestamps
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  managedDepartments Department[]       @relation("DepartmentManager")
  privilegeRequests  PrivilegeRequest[] @relation("Applicant")
  approvals          Approval[]         @relation("Approver")
  escalationsReceived Escalation[]      @relation("EscalationApprover")
  level2Escalations  Escalation[]       @relation("Level2Manager")
  authUser           AuthUser?

  @@index([email])
  @@index([jisrEmployeeId])
  @@index([departmentId])
  @@index([lineManagerId])
  @@index([role])
  @@index([status])
  @@map("users")
}

/// Departments synced from Jisr HR system
model Department {
  id                String       @id @default(cuid())
  jisrDepartmentId  Int          @unique
  nameEn            String
  nameAr            String?

  // Manager
  managerId         String?
  manager           User?        @relation("DepartmentManager", fields: [managerId], references: [id])

  // Hierarchy
  parentId          String?
  parent            Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children          Department[] @relation("DepartmentHierarchy")

  // Sync Information
  lastSyncedAt      DateTime?

  // Timestamps
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([jisrDepartmentId])
  @@index([managerId])
  @@index([parentId])
  @@map("departments")
}

/// Locations synced from Jisr HR system
model Location {
  id              String    @id @default(cuid())
  jisrLocationId  Int       @unique
  countryId       Int?
  areaId          Int?
  addressEn       String?
  addressAr       String?

  // Sync Information
  lastSyncedAt    DateTime?

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([jisrLocationId])
  @@map("locations")
}

/// System settings (singleton configuration)
model SystemSettings {
  id                        String         @id @default("default")

  // Jisr Integration
  jisrAccessToken           String?        // Encrypted
  jisrSlug                  String?

  // Email Configuration
  emailProvider             EmailProvider  @default(SMTP)
  smtpHost                  String?
  smtpPort                  Int?
  smtpUser                  String?
  smtpPassword              String?        // Encrypted
  graphClientId             String?
  graphClientSecret         String?        // Encrypted
  graphTenantId             String?
  fromEmail                 String?
  fromName                  String?

  // Sync Configuration
  syncIntervalHours         Int            @default(24)

  // Google Integration
  googleServiceAccountKey   String?        // Encrypted JSON
  googleDriveRootFolderId   String?
  googleDocsTemplates       Json?          // Template IDs mapping

  // Escalation Configuration
  escalationEnabled         Boolean        @default(true)
  escalationThresholds      Json?          // { level1Days: 3, level2Days: 5, level3Days: 7 }
  escalationHrEmail         String?

  // Testing/Development
  testingMode               Boolean        @default(false)
  testEmail                 String?

  // Timestamps
  updatedAt                 DateTime       @updatedAt

  @@map("system_settings")
}

/// Catalog of all clinical privileges
model Privilege {
  id                          String            @id @default(cuid())
  code                        String            @unique
  nameEn                      String
  nameAr                      String?
  category                    PrivilegeCategory
  requiresSpecialQualification Boolean          @default(false)
  description                 String?

  // CBAHI Approval Requirements
  requiredSpecialty           DentalSpecialty?  // Specialty required to perform this privilege
  isCore                      Boolean           @default(false)  // Core privilege (auto-approved)
  minPractitionerType         PractitionerType? // Minimum practitioner level required

  // Status
  isActive                    Boolean           @default(true)

  // Timestamps
  createdAt                   DateTime          @default(now())
  updatedAt                   DateTime          @updatedAt

  // Relations
  requestedPrivileges         RequestedPrivilege[]

  @@index([code])
  @@index([category])
  @@index([isActive])
  @@index([requiredSpecialty])
  @@map("privileges")
}

/// Privilege requests from applicants
model PrivilegeRequest {
  id                    String               @id @default(cuid())

  // Applicant
  applicantId           String
  applicant             User                 @relation("Applicant", fields: [applicantId], references: [id])

  // Request Type
  type                  RequestType          @default(NEW)
  reapplicationReason   String?
  requestType           PrivilegeRequestType @default(CORE)

  // Additional Information
  hospitalCenter        String?
  currentJob            String?

  // Status
  status                RequestStatus        @default(DRAFT)

  // Google Drive Integration
  driveFolderId         String?
  checklistDocId        String?
  checklistPdfUrl       String?
  privilegesFormDocId   String?
  privilegesFormPdfUrl  String?
  approvalFormDocId     String?
  approvalFormPdfUrl    String?

  // Timestamps
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  submittedAt           DateTime?
  completedAt           DateTime?

  // Relations
  requestedPrivileges   RequestedPrivilege[]
  approvals             Approval[]
  attachments           Attachment[]
  escalations           Escalation[]
  notificationLogs      NotificationLog[]

  @@index([applicantId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([submittedAt])
  @@map("privilege_requests")
}

/// Junction table for requested privileges
model RequestedPrivilege {
  id            String          @id @default(cuid())

  // Relations
  requestId     String
  request       PrivilegeRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  privilegeId   String
  privilege     Privilege        @relation(fields: [privilegeId], references: [id])

  // Status
  status        PrivilegeStatus  @default(PENDING)
  gdharApproval Boolean?         // Gulf Dental Health Authority Region approval

  // Comments
  comments      String?

  // Timestamps
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([requestId, privilegeId])
  @@index([requestId])
  @@index([privilegeId])
  @@index([status])
  @@map("requested_privileges")
}

/// Approvals for privilege requests
model Approval {
  id          String         @id @default(cuid())

  // Relations
  requestId   String
  request     PrivilegeRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  approverId  String
  approver    User           @relation("Approver", fields: [approverId], references: [id])

  // Approval Details
  level       ApprovalLevel
  status      ApprovalStatus @default(PENDING)
  comments    String?
  signature   String?        // Base64 encoded signature or signature reference

  // Timestamps
  approvedAt  DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  escalations Escalation[]

  @@unique([requestId, level])
  @@index([requestId])
  @@index([approverId])
  @@index([level])
  @@index([status])
  @@map("approvals")
}

/// Attachments for privilege requests
model Attachment {
  id            String           @id @default(cuid())

  // Relations
  requestId     String
  request       PrivilegeRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // File Information
  type          AttachmentType
  fileName      String
  fileSize      Int              // Size in bytes
  mimeType      String

  // Google Drive Integration
  driveFileId   String?
  driveFileUrl  String?

  // Timestamps
  uploadedAt    DateTime         @default(now())

  @@index([requestId])
  @@index([type])
  @@map("attachments")
}

/// Escalations for overdue approvals
model Escalation {
  id                  String           @id @default(cuid())

  // Relations
  requestId           String
  request             PrivilegeRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  approverId          String
  approver            User             @relation("EscalationApprover", fields: [approverId], references: [id])
  approvalId          String
  approval            Approval         @relation(fields: [approvalId], references: [id])

  // Timestamps
  receivedAt          DateTime         // When approver received the request

  // Level 1 Escalation (to approver)
  level1Sent          Boolean          @default(false)
  level1SentAt        DateTime?

  // Level 2 Escalation (to line manager)
  level2Sent          Boolean          @default(false)
  level2SentAt        DateTime?
  level2ManagerId     String?
  level2Manager       User?            @relation("Level2Manager", fields: [level2ManagerId], references: [id])
  level2ManagerEmail  String?

  // Level 3 Escalation (to HR)
  level3Sent          Boolean          @default(false)
  level3SentAt        DateTime?

  // Status
  status              EscalationStatus @default(ACTIVE)
  resolvedAt          DateTime?
  notes               String?

  // Timestamps
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  @@index([requestId])
  @@index([approverId])
  @@index([approvalId])
  @@index([status])
  @@map("escalations")
}

/// Notification logs for email tracking
model NotificationLog {
  id              String             @id @default(cuid())

  // Relations (optional - notifications may be system-wide)
  requestId       String?
  request         PrivilegeRequest?  @relation(fields: [requestId], references: [id], onDelete: SetNull)

  // Notification Details
  type            NotificationType
  recipientEmail  String
  recipientName   String?
  subject         String

  // Status
  status          NotificationStatus @default(PENDING)
  errorMessage    String?

  // Timestamps
  sentAt          DateTime?
  createdAt       DateTime           @default(now())

  // Additional Data
  metadata        Json?              // Additional context (template vars, etc.)

  @@index([requestId])
  @@index([type])
  @@index([status])
  @@index([recipientEmail])
  @@index([sentAt])
  @@index([createdAt])
  @@map("notification_logs")
}

/// Sync logs for Jisr HR synchronization
model SyncLog {
  id            String    @id @default(cuid())
  entityType    String    // 'users', 'departments', 'locations'
  status        String    // 'started', 'completed', 'failed'
  recordsTotal  Int?
  recordsAdded  Int?
  recordsUpdated Int?
  recordsSkipped Int?
  errorMessage  String?
  startedAt     DateTime  @default(now())
  completedAt   DateTime?

  @@index([entityType])
  @@index([status])
  @@index([startedAt])
  @@map("sync_logs")
}

/// Audit log for tracking changes
model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String   // 'CREATE', 'UPDATE', 'DELETE', 'LOGIN', etc.
  entityType  String   // Table name
  entityId    String?
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// CBAHI APPROVAL REQUIREMENTS (per government MOH guidelines)
// ============================================================================

/// Approval requirements based on practitioner type and privilege category
/// This implements the CBAHI/MOH matrix for clinical privileges approval
model ApprovalRequirement {
  id                      String               @id @default(cuid())
  
  // Matching criteria
  privilegeType           PrivilegeRequestType // CORE, NON_CORE, EXTRA
  practitionerType        PractitionerType     // GP, SPECIALIST, CONSULTANT
  sameSpecialty           Boolean              // Is the privilege in the applicant's specialty?
  
  // Approval requirements
  requiredConsultants     Int                  @default(0)  // Number of consultant approvals needed
  requiresCommittee       Boolean              @default(false)  // Requires committee review
  requiresMedicalDirector Boolean              @default(true)   // Requires MD final approval
  autoApprove             Boolean              @default(false)  // Auto-approve (core privileges)
  
  // Description
  descriptionEn           String?
  descriptionAr           String?
  
  // Status
  isActive                Boolean              @default(true)
  
  // Timestamps
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt

  @@unique([privilegeType, practitionerType, sameSpecialty])
  @@index([privilegeType])
  @@index([practitionerType])
  @@map("approval_requirements")
}

// ============================================================================
// NEXTAUTH MODELS
// ============================================================================

/// NextAuth Account model for OAuth providers
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

/// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

/// NextAuth User model (links to our User model)
model AuthUser {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  // Link to our User model (synced from Jisr)
  userId        String?   @unique
  user          User?     @relation(fields: [userId], references: [id])

  accounts      Account[]
  sessions      Session[]

  @@index([email])
  @@map("auth_users")
}

/// NextAuth Verification Token model for magic link
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
